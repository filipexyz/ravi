/**
 * Internal Plugins Registry (auto-generated)
 *
 * DO NOT EDIT - This file is generated by scripts/gen-plugins.ts
 * Run: bun run gen:plugins
 *
 * Contains embedded plugin data for: ravi-system, ravi-dev
 */

export interface PluginFile {
  path: string;
  content: string;
}

export interface InternalPlugin {
  name: string;
  manifest: Record<string, unknown>;
  files: PluginFile[];
}

/** Embedded internal plugins */
export const INTERNAL_PLUGINS: InternalPlugin[] = [
  {
    "name": "ravi-system",
    "manifest": {
      "name": "ravi-system",
      "version": "1.0.0",
      "description": "Ravi system management skills - agents, contacts, triggers, routes, and more"
    },
    "files": [
      {
        "path": ".claude-plugin/plugin.json",
        "content": "{\n  \"name\": \"ravi-system\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Ravi system management skills - agents, contacts, triggers, routes, and more\"\n}\n"
      },
      {
        "path": "skills/settings/SKILL.md",
        "content": "---\nname: settings-manager\ndescription: |\n  Gerencia configurações globais do Ravi. Use quando o usuário quiser:\n  - Ver ou alterar configurações do sistema\n  - Definir agent default\n  - Configurar DM scope padrão\n  - Ver todas as settings disponíveis\n---\n\n# Settings Manager\n\nConfigurações globais do sistema Ravi.\n\n## Comandos\n\n### Listar todas\n```bash\nravi settings list\n```\n\n### Ver valor\n```bash\nravi settings get <key>\n```\n\n### Definir valor\n```bash\nravi settings set <key> <value>\n```\n\n### Remover\n```bash\nravi settings delete <key>\n```\n\n## Settings Disponíveis\n\n| Key | Descrição | Valores |\n|-----|-----------|---------|\n| `defaultAgent` | Agent padrão quando nenhuma rota casa | ID do agent |\n| `defaultDmScope` | Escopo padrão de DMs | main, per-peer, per-channel-peer, per-account-channel-peer |\n| `defaultTimezone` | Fuso horário padrão | America/Sao_Paulo, etc |\n\n## Exemplos\n\nDefinir agent default:\n```bash\nravi settings set defaultAgent main\n```\n\nConfigurar timezone:\n```bash\nravi settings set defaultTimezone America/Sao_Paulo\n```\n"
      },
      {
        "path": "skills/video/SKILL.md",
        "content": "---\nname: video\ndescription: |\n  Analisa vídeos do YouTube ou arquivos locais via Gemini. Use quando o usuário quiser:\n  - Assistir/analisar um vídeo do YouTube\n  - Transcrever um vídeo\n  - Entender o conteúdo de um vídeo\n  - Extrair informações de um vídeo\n---\n\n# Video Analysis\n\nAnalisa vídeos usando a API do Gemini. Suporta URLs do YouTube (públicos) e arquivos locais.\n\n## Como usar\n\n### Analisar vídeo do YouTube\n```bash\nravi video analyze \"https://www.youtube.com/watch?v=VIDEO_ID\"\n```\n\n### Analisar com output específico\n```bash\nravi video analyze \"https://www.youtube.com/watch?v=VIDEO_ID\" -o ./video-analysis.md\n```\n\n### Analisar com prompt custom\n```bash\nravi video analyze \"https://www.youtube.com/watch?v=VIDEO_ID\" -p \"Foque nos argumentos técnicos apresentados\"\n```\n\n### Analisar arquivo local\n```bash\nravi video analyze /path/to/video.mp4\n```\n\n## O que é extraído\n\nO comando salva um `.md` no diretório atual com:\n\n- **Título** do vídeo\n- **Resumo** completo do conteúdo\n- **Tópicos** principais abordados\n- **Transcrição** de toda a fala\n- **Descrição visual** timestamped (o que acontece visualmente)\n\n## Fluxo recomendado\n\n1. Rode `ravi video analyze <url>` — gera o `.md`\n2. Leia o arquivo gerado com a tool Read\n3. Interprete e responda ao usuário baseado no conteúdo\n\n## Limitações\n\n- Só vídeos **públicos** do YouTube (não funciona com privados/não listados)\n- Vídeos muito longos (>1h) podem demorar ou exceder limites de token\n- Requer `GEMINI_API_KEY` configurada no `~/.ravi/.env`\n- Formatos locais suportados: mp4, mpeg, mov, avi, flv, webm, wmv, 3gpp\n\n## Configuração\n\nA variável `GEMINI_API_KEY` precisa estar no `~/.ravi/.env`. O modelo padrão é `gemini-2.5-flash`, configurável via `GEMINI_VIDEO_MODEL`.\n"
      },
      {
        "path": "skills/triggers/SKILL.md",
        "content": "---\nname: trigger-manager\ndescription: |\n  Gerencia triggers de eventos do sistema Ravi. Use quando o usuário quiser:\n  - Criar, listar, ver ou deletar triggers\n  - Configurar reações automáticas a eventos (CLI, SDK tools, mensagens)\n  - Ativar/desativar triggers existentes\n  - Testar triggers manualmente\n---\n\n# Trigger Manager\n\nVocê gerencia os triggers de eventos do Ravi. Triggers são reações automáticas que disparam quando eventos específicos acontecem no sistema.\n\n## Comandos Disponíveis\n\n### Listar triggers\n```bash\nravi triggers list\n```\n\n### Ver detalhes de um trigger\n```bash\nravi triggers show <id>\n```\n\n### Criar trigger\n```bash\nravi triggers add \"<nome>\" --topic \"<pattern>\" --message \"<prompt>\"\n```\n\nOpções:\n- `--agent <id>` - Agent que processa (default: agent padrão)\n- `--cooldown <duration>` - Intervalo mínimo entre disparos (ex: 5s, 1m, 30s)\n- `--session <main|isolated>` - Sessão (default: isolated)\n\n### Ativar/Desativar\n```bash\nravi triggers enable <id>\nravi triggers disable <id>\n```\n\n### Configurar propriedades\n```bash\nravi triggers set <id> <key> <value>\n```\nKeys: name, message, topic, agent, session, cooldown\n\n### Testar trigger\n```bash\nravi triggers test <id>\n```\n\n### Deletar\n```bash\nravi triggers rm <id>\n```\n\n## Tópicos Disponíveis\n\nPatterns usam wildcards (`*`):\n\n### Inbound e Canais\n\n| Pattern | Descrição |\n|---------|-----------|\n| `whatsapp.*.inbound` | Mensagens WhatsApp recebidas |\n| `matrix.*.inbound` | Mensagens Matrix recebidas |\n| `ravi.inbound.reaction` | Reações recebidas (emoji) |\n| `ravi.inbound.reply` | Replies a mensagens do bot |\n| `ravi.inbound.pollVote` | Votos em enquetes |\n\n### Contatos e Aprovações\n\n| Pattern | Descrição |\n|---------|-----------|\n| `ravi.contacts.pending` | Novo contato/grupo pendente de aprovação |\n| `ravi.approval.request` | Pedido de aprovação cascading |\n| `ravi.approval.response` | Resposta de aprovação |\n\n### Agent e Tools\n\n| Pattern | Descrição |\n|---------|-----------|\n| `ravi.*.cli.{group}.{command}` | Execuções de CLI tools (ex: `ravi.*.cli.contacts.add`) |\n| `ravi.*.tool` | Execuções de SDK tools (Bash, Read, etc) |\n\n### Outbound\n\n| Pattern | Descrição |\n|---------|-----------|\n| `ravi.outbound.deliver` | Mensagens enviadas para canais |\n| `ravi.outbound.receipt` | Read receipts enviados |\n| `ravi.outbound.refresh` | Refresh de filas outbound |\n\n**Bloqueados (anti-loop):** Triggers em `.prompt`, `.response` e `.claude` são rejeitados para evitar loops.\n\n## Exemplos\n\nCriar trigger para notificar quando lead é qualificado:\n```bash\nravi triggers add \"Lead Qualificado\" --topic \"ravi.*.cli.outbound.qualify\" --message \"Analise a qualificação e notifique o grupo\"\n```\n\nCriar trigger para monitorar erros:\n```bash\nravi triggers add \"Agent Error\" --topic \"ravi.*.tool\" --message \"Analise o erro e sugira correção\" --cooldown 1m\n```\n\n## Relação com NATS\n\nTriggers reagem a eventos do **NATS** (o barramento de eventos do Ravi). Para entender os tópicos disponíveis, consulte a skill `events`.\n\n- **NATS** = barramento de eventos (pub/sub direto)\n- **triggers** = reações automáticas a eventos NATS\n"
      },
      {
        "path": "skills/contacts/SKILL.md",
        "content": "---\nname: contacts-manager\ndescription: |\n  Gerencia contatos do sistema Ravi. Use quando o usuário quiser:\n  - Listar, adicionar, aprovar ou bloquear contatos\n  - Ver contatos pendentes de aprovação\n  - Configurar agent ou modo de resposta por contato\n  - Adicionar/remover tags ou buscar por tags\n  - Ver detalhes de um contato específico\n---\n\n# Contacts Manager\n\nVocê gerencia os contatos do Ravi. Contatos controlam quem pode interagir com o sistema e como são roteados.\n\n## Status de Contatos\n\n| Status | Descrição |\n|--------|-----------|\n| `allowed` | Pode interagir normalmente |\n| `pending` | Aguardando aprovação |\n| `blocked` | Bloqueado, mensagens ignoradas |\n| `discovered` | Descoberto mas não aprovado |\n\n## Comandos Disponíveis\n\n### Listar contatos\n```bash\nravi contacts list\n```\n\n### Ver pendentes\n```bash\nravi contacts pending\n```\n\n### Adicionar contato\n```bash\nravi contacts add <phone> [nome]\n```\n\n### Aprovar pendente\n```bash\nravi contacts approve <phone> [agent] [mode]\n```\n- `agent` - Agent ID para rotear (opcional)\n- `mode` - `auto` (responde sempre) ou `mention` (só quando mencionado)\n\n### Bloquear/Permitir\n```bash\nravi contacts block <phone>\nravi contacts allow <phone>\n```\n\n### Remover\n```bash\nravi contacts remove <phone>\n```\n\n### Ver detalhes\n```bash\nravi contacts check <phone>\n```\n\n### Configurar propriedades\n```bash\nravi contacts set <phone> <key> <value>\n```\n\nKeys disponíveis:\n- `agent` - Agent ID para rotear\n- `mode` - `auto` ou `mention`\n- `email` - Email do contato\n- `name` - Nome do contato\n- `tags` - Array JSON: `'[\"lead\",\"vip\"]'`\n- `notes` - Objeto JSON: `'{\"empresa\":\"Acme\"}'`\n- `opt-out` - `true` ou `false`\n\n## Tags\n\n### Adicionar tag\n```bash\nravi contacts tag <phone> <tag>\n```\n\n### Remover tag\n```bash\nravi contacts untag <phone> <tag>\n```\n\n### Buscar por tag\n```bash\nravi contacts find <tag> --tag\n```\n\n### Buscar por texto\n```bash\nravi contacts find <query>\n```\n\n## Exemplos\n\nAprovar contato e rotear para agent específico:\n```bash\nravi contacts approve 5511999999999 vendas auto\n```\n\nAdicionar tags a um contato:\n```bash\nravi contacts tag 5511999999999 lead\nravi contacts tag 5511999999999 interessado\n```\n\nConfigurar notas com contexto:\n```bash\nravi contacts set 5511999999999 notes '{\"empresa\":\"TechCorp\",\"cargo\":\"CTO\"}'\n```\n\n## Relação com Routes\n\nContacts e Routes trabalham juntos no roteamento:\n\n- **Contacts** podem ter `agent_id` direto — isso tem prioridade sobre routes\n- **Routes** definem regras por padrão (prefixo, grupo, catch-all) como fallback\n- `ravi contacts list` mostra o agent e modo de resposta de cada contato\n- Para gerenciar rotas: use a skill `ravi-system:routes`\n- Ordem de resolução: contact.agent_id > route match > accountId > default agent\n"
      },
      {
        "path": "skills/cross/SKILL.md",
        "content": "---\nname: cross-manager\ndescription: |\n  DEPRECADO — use os comandos de sessions:\n  - ravi sessions send <session> \"mensagem\"\n  - ravi sessions ask <session> \"pergunta\" \"sender\"\n  - ravi sessions answer <session> \"resposta\" \"sender\"\n  - ravi sessions execute <session> \"tarefa\"\n  - ravi sessions inform <session> \"info\"\n---\n\n# Cross Manager (DEPRECADO)\n\nOs comandos `ravi cross send` e `ravi cross list` foram migrados para `ravi sessions`.\n\n## Migração\n\n| Antes | Agora |\n|-------|-------|\n| `ravi cross send <target> relay \"msg\"` | `ravi sessions send <session> \"msg\"` |\n| `ravi cross send <target> inform \"msg\"` | `ravi sessions inform <session> \"msg\"` |\n| `ravi cross send <target> execute \"msg\"` | `ravi sessions execute <session> \"msg\"` |\n| `ravi cross send <target> ask \"msg\" \"sender\"` | `ravi sessions ask <session> \"msg\" \"sender\"` |\n| `ravi cross send <target> answer \"msg\" \"sender\"` | `ravi sessions answer <session> \"msg\" \"sender\"` |\n| `ravi cross list` | `ravi sessions list` |\n\n## Notas\n\n- Targets agora usam **session names** (ex: `main`, `e2-filipe-e2`) em vez de session keys\n- Source/context são resolvidos automaticamente da sessão\n- Use `--channel` e `--to` para override explícito de routing\n"
      },
      {
        "path": "skills/agents/SKILL.md",
        "content": "---\nname: agents-manager\ndescription: |\n  Gerencia agents do sistema Ravi. Use quando o usuário quiser:\n  - Criar, configurar ou deletar agents\n  - Gerenciar permissões de tools (whitelist/bypass)\n  - Configurar permissões de Bash (allowlist/denylist)\n  - Ver ou resetar sessões de agents\n  - Configurar debounce de mensagens\n  - Entender como rotear mensagens pra um agent\n---\n\n# Agents Manager\n\nAgents são instâncias do Claude com configurações específicas (diretório, tools, permissões). Cada agent tem seu workspace, sessões independentes e pode atender canais/contatos diferentes.\n\n**Importante:** Criar ou modificar agents **não requer restart** do daemon. Tudo atualiza em tempo real.\n\n## Fluxo Completo: Criar um Agent e Colocar pra Funcionar\n\n### 1. Criar o agent\n\n```bash\nravi agents create <id> <cwd>\n```\n\nO `cwd` é o diretório onde fica o `CLAUDE.md` do agent (suas instruções). Crie o diretório e o `CLAUDE.md` antes.\n\n### 2. Rotear mensagens pro agent\n\nExistem duas formas de rotear:\n\n**Por rota (padrão de grupo/contato):**\n```bash\nravi routes add <pattern> <agent>\n```\n\nPatterns suportados:\n- `group:120363425628305127` — grupo específico\n- `lid:178035101794451` — contato específico (por lid)\n- `5511*` — todos com DDD 11\n- `*` — catch-all\n\n**Por contato (assignment direto):**\n```bash\nravi contacts approve <phone> <agent>\n# ou\nravi contacts set <phone> agent <agent>\n```\n\n### 3. Ativar em grupo WhatsApp\n\nGrupos novos precisam ser **aprovados** antes de funcionar.\n\n**Instrua o usuário a:**\n1. Criar um grupo no WhatsApp e adicionar o bot\n2. Mandar uma mensagem qualquer no grupo (isso faz o grupo aparecer como **pending**)\n\n**Depois, VOCÊ (o agent) deve executar:**\n```bash\nravi contacts pending                            # Checar pendentes — o grupo aparece aqui\nravi contacts approve <group-id> <agent>         # Aprovar e associar ao agent\nravi routes add <group-id> <agent>               # Criar rota pro grupo\n```\n\n**IMPORTANTE:** Não peça o ID do grupo pro usuário. Rode `ravi contacts pending` pra descobrir o ID automaticamente. O usuário já mandou a mensagem — o grupo já está lá.\n\nTudo atualiza em tempo real. **Não precisa reiniciar o daemon.**\n\n### Como novos contatos/grupos aparecem?\n\nQuando alguém novo manda mensagem (ou o bot é adicionado a um grupo novo), o contato/grupo aparece como **pending** automaticamente. Nenhuma mensagem é processada até ser aprovado.\n\n```bash\nravi contacts pending     # Ver contatos/grupos pendentes\n```\n\nPra aprovar e rotear:\n```bash\nravi contacts approve <phone> <agent>   # Aprova e associa ao agent\nravi contacts approve <phone>           # Aprova sem associar (usa rota ou default)\nravi contacts block <phone>             # Bloqueia\n```\n\n### Prioridade de roteamento\n\nQuando uma mensagem chega, o sistema resolve o agent nesta ordem:\n\n1. **Contato tem agent?** → usa o agent do contato\n2. **Tem rota que casa?** → usa o agent da rota (prioridade maior primeiro)\n3. **Account ID casa com agent?** → usa (Matrix multi-account)\n4. **Nenhum match** → usa o agent default (geralmente `main`)\n\n## Comandos Disponíveis\n\n### Listar agents\n```bash\nravi agents list\n```\n\n### Ver detalhes\n```bash\nravi agents show <id>\n```\n\n### Criar agent\n```bash\nravi agents create <id> <cwd>\n```\n\n### Deletar agent\n```bash\nravi agents delete <id>\n```\n\n### Configurar propriedades\n```bash\nravi agents set <id> <key> <value>\n```\n\nKeys:\n- `name` — Nome do agent\n- `cwd` — Diretório de trabalho\n- `model` — Modelo (claude-opus-4-6, claude-sonnet-4-5-20250929, etc)\n- `dmScope` — Escopo de sessão DM:\n  - `main` — Todas as DMs numa sessão só\n  - `per-peer` — Uma sessão por contato (default)\n  - `per-channel-peer` — Por canal + contato\n  - `per-account-channel-peer` — Isolamento total\n- `systemPromptAppend` — Texto adicional no system prompt\n- `matrixAccount` — Conta Matrix associada\n\n## Permissões (REBAC)\n\nPermissões de tools e executáveis são gerenciadas via REBAC:\n\n```bash\n# Ver permissões de um agent\nravi permissions list --subject agent:<id>\n\n# Configurar permissões\nravi permissions init agent:<id> full-access     # Tudo liberado\nravi permissions init agent:<id> sdk-tools       # SDK tools padrão\nravi permissions init agent:<id> safe-executables # Executáveis seguros\n\n# Grants individuais\nravi permissions grant agent:<id> use tool:Bash\nravi permissions grant agent:<id> execute executable:git\n```\n\nVer skill `permissions-manager` para documentação completa.\n\n## Debounce de Mensagens\n\nAgrupa mensagens rápidas antes de processar:\n\n```bash\nravi agents debounce <id> <ms>   # Definir (ex: 2000 = 2s)\nravi agents debounce <id> 0      # Desabilitar\nravi agents debounce <id>        # Ver atual\n```\n\n## Sessões\n\n### Ver sessões\n```bash\nravi agents session <id>\n```\n\n### Resetar sessão\n```bash\nravi agents reset <id>              # Sessão principal\nravi agents reset <id> <sessionKey> # Sessão específica\nravi agents reset <id> all          # Todas as sessões\n```\n\n## Interação\n\n### Enviar prompt\n```bash\nravi agents run <id> \"prompt\"\n```\n\n### Chat interativo\n```bash\nravi agents chat <id>\n```\n\n## Receita Completa: Agent Pessoal com Grupo WhatsApp\n\nAgents pessoais são agents dedicados a um aspecto da vida do usuário (comunicação, journaling, estratégia, etc). Cada um tem seu grupo WhatsApp exclusivo.\n\n**Conceito importante:** O agent já nasce dentro do WhatsApp. Ele não precisa de nenhuma tool pra enviar mensagens — toda resposta dele já chega automaticamente no WhatsApp. Ele deve saber disso no CLAUDE.md.\n\n### Passo a passo\n\n#### 1. Criar diretório e CLAUDE.md\n\n```bash\nmkdir -p ~/ravi/<agent-id>\n```\n\nEscreva o `CLAUDE.md` com a identidade e instruções do agent. Estrutura recomendada:\n\n```markdown\n# <Nome do Agent>\n\n## Quem Você É\n- Papel, personalidade, tom de voz\n- O que você faz e o que NÃO faz\n\n## Contexto\n- Você já está conversando pelo WhatsApp com o usuário\n- Toda mensagem que você envia chega diretamente no WhatsApp\n- Você NÃO precisa de nenhuma tool pra enviar mensagens\n\n## Como Funciona\n- Metodologia, frameworks, abordagem\n- Exemplos de interação\n\n## Regras\n- Limites, boundaries, o que evitar\n```\n\n**Dicas pro CLAUDE.md:**\n- Dê personalidade — agents genéricos são chatos\n- Seja específico sobre o que o agent faz e não faz\n- Inclua que ele já está no WhatsApp (não precisa de tool pra mensagem)\n- Adapte o tom pro contexto (coach é diferente de diário é diferente de estrategista)\n\n#### 2. Criar o agent no sistema\n\n```bash\nravi agents create <agent-id> ~/ravi/<agent-id>\n```\n\n#### 3. Criar grupo WhatsApp dedicado\n\nO usuário cria um grupo no WhatsApp (ex: \"Vida - Comunicação\") e adiciona o bot. Ao enviar a primeira mensagem no grupo, o contato aparece automaticamente como **pending**.\n\n#### 4. Aprovar e rotear o grupo\n\n**Não peça o ID do grupo pro usuário.** Rode o CLI pra descobrir:\n\n```bash\n# Ver grupos/contatos pendentes\nravi contacts pending\n\n# Aprovar o grupo\nravi contacts approve <group-id>\n\n# Criar rota pro agent\nravi routes add <group-id> <agent-id>\n```\n\nO `group-id` tem formato `group:120363406060070449`.\n\n#### 5. Pronto!\n\nO agent já está respondendo no grupo. Não precisa reiniciar o daemon.\n\n### Exemplo real: Agent de comunicação\n\n```bash\n# 1. Criar diretório\nmkdir -p ~/ravi/comm\n\n# 2. Escrever CLAUDE.md (com identidade de coach de comunicação)\n\n# 3. Criar agent\nravi agents create comm ~/ravi/comm\n\n# 4. Usuário cria grupo \"Vida - Comunicação\" no WhatsApp e manda msg\n\n# 5. Aprovar e rotear\nravi contacts pending                          # Encontra group:120363406060070449\nravi contacts approve group:120363406060070449  # Aprova\nravi routes add group:120363406060070449 comm   # Roteia pro comm\n```\n\n## Exemplos Práticos\n\n### Criar agent pra atendimento\n\n```bash\n# 1. Criar diretório e CLAUDE.md\nmkdir -p ~/ravi/atendimento\n# (crie o CLAUDE.md com as instruções do agent)\n\n# 2. Criar agent\nravi agents create atendimento ~/ravi/atendimento\n\n# 3. Rotear grupo pro agent\nravi routes add group:120363425628305127 atendimento\n\n# 4. Configurar permissões (via REBAC)\nravi permissions init agent:atendimento sdk-tools       # SDK tools padrão\nravi permissions init agent:atendimento safe-executables # Executáveis seguros\nravi permissions grant agent:atendimento use tool:Bash   # Liberar Bash\n```\n\n### Aprovar contato e associar a agent\n\n```bash\n# Ver pendentes\nravi contacts pending\n\n# Aprovar e associar\nravi contacts approve 5511999999999 atendimento\n\n# Ou aprovar com modo \"mention\" (só responde quando mencionado)\nravi contacts approve 5511999999999 atendimento mention\n```\n\n### Configurar rota com prioridade\n\n```bash\n# Rota específica (prioridade alta)\nravi routes add group:123456789 vendas\nravi routes set group:123456789 priority 10\n\n# Rota catch-all (prioridade baixa)\nravi routes add \"*\" main\n```\n"
      },
      {
        "path": "skills/permissions/SKILL.md",
        "content": "---\nname: permissions-manager\ndescription: |\n  Gerencia permissões REBAC do sistema Ravi. Use quando o usuário quiser:\n  - Ver, conceder ou revocar permissões de agents\n  - Verificar se um agent tem permissão pra algo\n  - Sincronizar permissões com configs dos agents\n  - Entender o modelo de permissões\n---\n\n# Permissions Manager (REBAC)\n\nPermissões no Ravi são relações: **(sujeito) tem (relação) sobre (objeto)**.\n\nExemplo: `(agent:dev) access (session:dev-*)` — o agent dev pode acessar sessões que começam com \"dev-\".\n\n## IMPORTANTE: Object Types\n\nO object type no grant DEVE corresponder ao que o engine checa. Se errar o type, a permissão não funciona.\n\n**Regra:** Comandos CLI usam `group:<nome-do-grupo>`. Sessões usam `session:<pattern>`. Sistema usa `system:*`.\n\n## Referência Rápida de Grants\n\n### Acesso a grupos de comandos CLI (scope: admin)\n\nO scope `admin` no decorator `@Group` checa `execute` no object type `group`:\n\n```bash\n# Formato: ravi permissions grant agent:<id> execute group:<grupo>\n\n# Daemon (restart, status, logs)\nravi permissions grant agent:dev execute group:daemon\n\n# Agents (create, delete, set, tools, bash)\nravi permissions grant agent:dev execute group:agents\n\n# Sessions (list, send, ask, read, reset, delete...)\nravi permissions grant agent:dev execute group:sessions\n\n# Contacts (list, add, approve, block, tags)\nravi permissions grant agent:dev execute group:contacts\n\n# Routes (add, remove, set, list)\nravi permissions grant agent:dev execute group:routes\n\n# Settings (list, get, set)\nravi permissions grant agent:dev execute group:settings\n\n# Channels (status, start, stop, restart)\nravi permissions grant agent:dev execute group:channels\n\n# Heartbeat (set, enable, disable, trigger)\nravi permissions grant agent:dev execute group:heartbeat\n\n# Matrix (add, remove, send, rooms)\nravi permissions grant agent:dev execute group:matrix\n\n# WhatsApp groups (create, members, invite)\nravi permissions grant agent:dev execute group:whatsapp.group\n\n# Service (install, uninstall, start, stop)\nravi permissions grant agent:dev execute group:service\n```\n\n**Subcomando específico** — dá acesso a só um comando dentro do grupo:\n```bash\n# Só restart, não status/logs\nravi permissions grant agent:dev execute group:daemon_restart\n\n# Só list, não create/delete\nravi permissions grant agent:dev execute group:agents_list\n```\n\n### Superadmin (scope: superadmin)\n\n```bash\n# Acesso total — permissions, e todos os outros grupos\nravi permissions grant agent:dev admin system:*\n```\n\n### Sessões (inline scope checks)\n\n```bash\n# Acessar sessões (ler, enviar)\nravi permissions grant agent:dev access session:dev-*\n\n# Modificar sessões (reset, delete, rename, set-model)\nravi permissions grant agent:dev modify session:dev-*\n```\n\n### Contatos (scope: writeContacts)\n\n```bash\n# Criar/aprovar/bloquear contatos\nravi permissions grant agent:dev write_contacts system:*\n\n# Ler contatos das próprias sessões\nravi permissions grant agent:dev read_own_contacts system:*\n\n# Ler contatos com tag específica\nravi permissions grant agent:dev read_tagged_contacts system:leads\n```\n\n### Grupos que NÃO precisam de grant (scope: open/resource)\n\nEstes funcionam pra qualquer agent sem grant:\n- `sessions` (open) — mas comandos de modificação checam session scope inline\n- `media` (open)\n- `react` (open)\n- `tools` (open)\n- `transcribe` (open)\n- `video` (open)\n- `whatsapp.dm` (open)\n- `cron` (resource) — checa ownership do recurso\n- `triggers` (resource) — checa ownership do recurso\n- `outbound` (resource) — checa ownership do recurso\n\n## ERROS COMUNS\n\n❌ **ERRADO** — usar `system:daemon` pra liberar o grupo daemon:\n```bash\nravi permissions grant agent:dev execute system:daemon\n```\nIsso não funciona! O engine checa `group:daemon`, não `system:daemon`.\n\n✅ **CERTO:**\n```bash\nravi permissions grant agent:dev execute group:daemon\n```\n\n❌ **ERRADO** — usar `admin` pra dar acesso a um grupo específico:\n```bash\nravi permissions grant agent:dev admin group:daemon\n```\n`admin` só funciona com `system:*` (superadmin total).\n\n✅ **CERTO** — usar `execute`:\n```bash\nravi permissions grant agent:dev execute group:daemon\n```\n\n❌ **ERRADO** — confundir `group` com `executable`:\n```bash\nravi permissions grant agent:dev execute group:*   # libera comandos CLI, NÃO executáveis\n```\n\n✅ **CERTO** — object types separados:\n```bash\nravi permissions grant agent:dev execute group:*        # comandos CLI\nravi permissions grant agent:dev execute executable:*   # executáveis do sistema\n```\n\n❌ **ERRADO** — relação errada pra executáveis:\n```bash\nravi permissions grant agent:dev use executable:git   # \"use\" é pra SDK tools\n```\n\n✅ **CERTO:**\n```bash\nravi permissions grant agent:dev execute executable:git  # executáveis usam \"execute\"\nravi permissions grant agent:dev use tool:Bash           # SDK tools usam \"use\"\n```\n\n### SDK Tools (use tool:*)\n\nControla quais SDK tools (Bash, Read, Edit, Write, etc.) um agent pode usar:\n\n```bash\n# Permitir tool específica\nravi permissions grant agent:dev use tool:Bash\nravi permissions grant agent:dev use tool:Read\n\n# Permitir TODAS as tools (bypass)\nravi permissions grant agent:dev use tool:*\n\n# Verificar\nravi permissions check agent:dev use tool:Bash\n```\n\nSDK tools disponíveis: `Bash`, `Read`, `Edit`, `Write`, `Glob`, `Grep`, `WebFetch`, `WebSearch`, `Task`, `TodoRead`, `TodoWrite`, `NotebookEdit`, `AskUserQuestion`.\n\n### Executáveis do sistema (execute executable:*)\n\nControla quais binários do sistema um agent pode rodar via Bash:\n\n```bash\n# Permitir executável específico\nravi permissions grant agent:dev execute executable:git\nravi permissions grant agent:dev execute executable:node\nravi permissions grant agent:dev execute executable:ravi\n\n# Permitir TODOS os executáveis (bypass)\nravi permissions grant agent:dev execute executable:*\n\n# Verificar\nravi permissions check agent:dev execute executable:git\n```\n\n### Templates (atalhos)\n\n```bash\n# SDK tools padrão (Bash, Read, Edit, Write, etc.)\nravi permissions init agent:dev sdk-tools\n\n# Todas as SDK tools\nravi permissions init agent:dev all-tools\n\n# Executáveis seguros (git, node, bun, ravi, etc.)\nravi permissions init agent:dev safe-executables\n\n# Tudo: todas tools + todos executáveis\nravi permissions init agent:dev full-access\n```\n\n## Comandos\n\n### Listar permissões\n```bash\n# Todas\nravi permissions list\n\n# De um agent específico\nravi permissions list --subject agent:dev\n\n# De um tipo de objeto\nravi permissions list --object group:contacts\n\n# Por relação\nravi permissions list --relation access\n\n# Por source\nravi permissions list --source manual\n```\n\n### Conceder permissão\n```bash\nravi permissions grant <sujeito> <relação> <objeto>\n```\n\n### Revocar permissão\n```bash\nravi permissions revoke <sujeito> <relação> <objeto>\n```\n\n### Verificar permissão\n```bash\nravi permissions check <sujeito> <permissão> <objeto>\n```\n\nVerifica se a permissão é resolvida (incluindo wildcards e admin).\n\n```bash\n# Dev pode restartar o daemon?\nravi permissions check agent:dev execute group:daemon\n\n# Dev pode acessar sessão dev-grupo1?\nravi permissions check agent:dev access session:dev-grupo1\n\n# Main é superadmin?\nravi permissions check agent:main admin system:*\n```\n\n### Sincronizar com configs\n```bash\nravi permissions sync\n```\n\nRe-lê as configs dos agents e regenera as relações `source=config`. Relações manuais não são afetadas.\n\n### Limpar permissões\n```bash\n# Limpar só manuais\nravi permissions clear\n\n# Limpar TUDO (inclusive config — rode sync depois)\nravi permissions clear --all\n```\n\n## Wildcards\n\nWildcards só funcionam no final do object ID:\n- `*` — tudo\n- `dev-*` — tudo que começa com \"dev-\"\n- ❌ `*-dev` ou `a*b` — inválidos\n\n## Sources\n\n- `config` — Geradas automaticamente a partir da config dos agents (re-sync no boot)\n- `manual` — Criadas via CLI, persistem entre restarts\n\n## Como Funciona a Resolução\n\nQuando o engine verifica `can(agent:dev, execute, group:daemon)`:\n\n1. Agent é superadmin? → checa `(agent:dev, admin, system:*)` → sim = allowed\n2. Relação direta? → checa `(agent:dev, execute, group:daemon)` → sim = allowed\n3. Wildcard? → checa `(agent:dev, execute, group:*)` → sim = allowed\n4. Pattern match? → checa patterns como `group:dae*` → match = allowed\n5. Nenhum match → denied\n"
      },
      {
        "path": "skills/heartbeat/SKILL.md",
        "content": "---\nname: heartbeat-manager\ndescription: |\n  Gerencia heartbeat dos agents. Use quando o usuário quiser:\n  - Configurar check-ins periódicos para agents\n  - Ativar/desativar heartbeat\n  - Definir intervalo e horários ativos\n  - Disparar heartbeat manualmente\n---\n\n# Heartbeat Manager\n\nHeartbeat são check-ins periódicos que um agent faz. O agent lê o arquivo HEARTBEAT.md do seu workspace e executa as instruções.\n\n## Como Funciona\n\n1. Agent tem heartbeat habilitado com intervalo (ex: 30min)\n2. A cada intervalo, o daemon envia prompt pro agent\n3. Agent lê HEARTBEAT.md e executa (ex: verificar pendências, enviar resumo)\n\n## Comandos\n\n### Ver status de todos\n```bash\nravi heartbeat status\n```\n\n### Ver config de um agent\n```bash\nravi heartbeat show <agent>\n```\n\n### Habilitar heartbeat\n```bash\nravi heartbeat enable <agent>\nravi heartbeat enable <agent> 30m    # Com intervalo\n```\n\n### Desabilitar heartbeat\n```bash\nravi heartbeat disable <agent>\n```\n\n### Configurar propriedades\n```bash\nravi heartbeat set <agent> interval 1h          # Intervalo\nravi heartbeat set <agent> model haiku          # Modelo (economia)\nravi heartbeat set <agent> active-hours 09:00-22:00  # Horário ativo\nravi heartbeat set <agent> active-hours always  # Sempre ativo\n```\n\n### Disparar manualmente\n```bash\nravi heartbeat trigger <agent>\n```\n\n## Arquivo HEARTBEAT.md\n\nCada agent precisa ter um `HEARTBEAT.md` no seu workspace com instruções do que fazer no check-in.\n\nExemplo:\n```markdown\n# Heartbeat - Check-in Periódico\n\n## O Que Verificar\n- Tarefas pendentes\n- Erros recentes nos logs\n- Mensagens não respondidas\n\n## Quando Notificar\n- Se algo importante ficou pendente\n- Se um processo crashou\n- Se há muito tempo sem interação\n\n## Como Notificar\nUse sessions inform para enviar mensagem:\nravi sessions inform <session-name> \"mensagem\"\n```\n\n## Exemplos\n\nConfigurar heartbeat básico:\n```bash\nravi heartbeat enable main 30m\n```\n\nHeartbeat só em horário comercial:\n```bash\nravi heartbeat enable main 1h\nravi heartbeat set main active-hours 09:00-18:00\n```\n\nUsar modelo mais barato:\n```bash\nravi heartbeat set main model haiku\n```\n\nTestar configuração:\n```bash\nravi heartbeat trigger main\nravi daemon logs -f\n```\n"
      },
      {
        "path": "skills/sessions/SKILL.md",
        "content": "---\nname: sessions\ndescription: |\n  Gerencia sessões do sistema Ravi. Use quando o usuário quiser:\n  - Listar, ver detalhes ou renomear sessões\n  - Resetar ou deletar sessões\n  - Configurar modelo ou thinking level por sessão\n  - Criar sessões efêmeras com TTL\n  - Estender, manter ou excluir sessões efêmeras\n  - Enviar prompts, perguntas ou comandos entre sessões\n  - Ler histórico de mensagens de uma sessão\n---\n\n# Sessions Manager\n\nSessões são conversas persistentes entre agents e usuários. Cada sessão tem um nome único, um agent associado, e pode ter canal de saída (WhatsApp, Matrix, etc).\n\n## Tipos de Sessão\n\n- **Permanent** (padrão): Sessão normal, sem expiração.\n- **Ephemeral**: Sessão com TTL (time-to-live). Expira automaticamente após o tempo definido. 10 minutos antes de expirar, o agent recebe um aviso com comandos CLI para estender, manter ou excluir.\n\n## Comandos\n\n### Listagem e Info\n\n```bash\n# Listar todas as sessões (mostra tipo e data de expiração)\nravi sessions list\n\n# Filtrar por agent\nravi sessions list --agent <id>\n\n# Listar só efêmeras\nravi sessions list --ephemeral\n\n# Ver detalhes de uma sessão\nravi sessions info <name>\n\n# Ler histórico de mensagens (normalizado, sem tool calls)\nravi sessions read <name> [-n count]\n```\n\n### Gerenciamento\n\n```bash\n# Renomear display name\nravi sessions rename <name> \"Novo Nome\"\n\n# Definir modelo override\nravi sessions set-model <name> <model>\n\n# Definir thinking level\nravi sessions set-thinking <name> <level>\n\n# Resetar sessão (limpa conversa, mantém config)\nravi sessions reset <name>\n\n# Deletar sessão permanentemente (abort + delete)\nravi sessions delete <name>\n```\n\n### Sessões Efêmeras\n\n```bash\n# Tornar sessão efêmera com TTL (ex: 5h, 30m, 1d)\nravi sessions set-ttl <name> <duration>\n\n# Estender TTL de uma sessão efêmera (+5h default)\nravi sessions extend <name> [duration]\n\n# Tornar sessão efêmera em permanente\nravi sessions keep <name>\n```\n\n**Fluxo automático:**\n1. Sessão criada com `set-ttl` recebe TTL\n2. 10 min antes de expirar, o agent recebe aviso via `[System] Inform:` com os comandos CLI\n3. O agent pode executar `extend`, `keep`, ou `delete`\n4. Sem ação → sessão é automaticamente deletada pelo runner\n\n### Comunicação Inter-Sessão\n\n```bash\n# Enviar prompt e esperar resposta (streaming)\nravi sessions send <name> \"mensagem\" [-a agent] [-i]\n# -a: criar sessão com esse agent se não existir\n# -i: modo interativo (loop)\n\n# Perguntar algo (fire-and-forget, agent pergunta no chat se não souber)\nravi sessions ask <name> \"pergunta\" [sender]\n\n# Responder uma pergunta de outra sessão (agent NUNCA silencia)\nravi sessions answer <name> \"resposta\" [sender]\n\n# Executar comando (fire-and-forget, agent executa sem responder)\nravi sessions execute <name> \"tarefa\"\n\n# Informar algo (fire-and-forget, agent pode silenciar se irrelevante)\nravi sessions inform <name> \"info\"\n```\n\n## Notas\n\n- **Reset vs Delete**: `reset` limpa a conversa mas mantém nome/routing/config. `delete` remove a sessão inteira.\n- **Session names**: Nomes legíveis, únicos, sem pontos (`.`). Gerados automaticamente ou definidos manualmente.\n- **Source automático**: Todos os comandos de comunicação incluem source (channel/chatId) automaticamente — o agent sabe onde responder.\n"
      },
      {
        "path": "skills/daemon/SKILL.md",
        "content": "---\nname: daemon-manager\ndescription: |\n  Controla o daemon do Ravi. Use quando o usuário quiser:\n  - Ver status do daemon\n  - Reiniciar o daemon\n  - Ver logs\n  - Instalar/desinstalar serviço do sistema\n---\n\n# Daemon Manager\n\nO daemon é o processo principal que roda o bot e os gateways.\n\n## Comandos\n\n### Status\n```bash\nravi daemon status\n```\n\n### Iniciar\n```bash\nravi daemon start\n```\n\n### Parar\n```bash\nravi daemon stop\n```\n\n### Reiniciar\n```bash\nravi daemon restart\nravi daemon restart --message \"Motivo do restart\"\n```\n\n### Logs\n```bash\nravi daemon logs              # Últimas linhas\nravi daemon logs --tail 50    # Últimas 50 linhas\nravi daemon logs --follow     # Acompanhar em tempo real\nravi daemon logs --clear      # Limpar logs\nravi daemon logs --path       # Mostrar caminho do arquivo\n```\n\n### Modo Dev\n```bash\nravi daemon dev   # Rebuild automático ao editar código\n```\n\n### Serviço do Sistema\n\nInstalar como serviço (inicia no boot):\n```bash\nravi daemon install\n```\n\nDesinstalar:\n```bash\nravi daemon uninstall\n```\n\n## Arquivos\n\n- **Logs**: `~/.ravi/logs/daemon.log`\n- **PID**: gerenciado pelo launchd/systemd\n- **Env**: `~/.ravi/.env`\n\n## Editar variáveis de ambiente\n```bash\nravi daemon env\n```\n"
      },
      {
        "path": "skills/skills/SKILL.md",
        "content": "---\nname: skill-creator\ndescription: |\n  Guia para criar skills no Claude Code. Use quando o usuário quiser:\n  - Criar uma nova skill\n  - Entender como skills funcionam\n  - Configurar frontmatter de skills\n  - Adicionar skills a plugins\n---\n\n# Skill Creator - Guia Completo\n\nSkills estendem as capacidades do Claude. São arquivos markdown com instruções que Claude segue quando a skill é invocada.\n\n## Estrutura de uma Skill\n\n```\nskills/\n└── minha-skill/\n    └── SKILL.md          # Arquivo principal (obrigatório)\n    ├── template.md       # Template opcional\n    ├── examples/         # Exemplos opcionais\n    └── scripts/          # Scripts auxiliares\n```\n\n## Formato do SKILL.md\n\n```yaml\n---\nname: nome-da-skill\ndescription: |\n  Descrição detalhada. Claude usa isso para decidir\n  quando carregar a skill automaticamente.\n---\n\n# Título da Skill\n\nInstruções que Claude segue quando a skill é ativada.\n```\n\n## Frontmatter - Todas as Opções\n\n| Campo | Obrigatório | Descrição |\n|-------|-------------|-----------|\n| `name` | Não | Nome da skill. Se omitido, usa o nome da pasta |\n| `description` | Recomendado | Quando usar. Claude usa pra decidir auto-invocação |\n| `argument-hint` | Não | Hint no autocomplete: `[issue-number]` |\n| `disable-model-invocation` | Não | `true` = só user pode invocar (default: false) |\n| `user-invocable` | Não | `false` = esconde do menu / (default: true) |\n| `allowed-tools` | Não | Tools permitidas: `Read, Grep, Glob` |\n| `model` | Não | Modelo específico para a skill |\n| `context` | Não | `fork` = roda em subagent isolado |\n| `agent` | Não | Tipo de subagent quando `context: fork` |\n| `hooks` | Não | Hooks específicos da skill |\n\n## Tipos de Skills\n\n### 1. Skill de Referência (conhecimento)\nClaude aplica ao trabalho atual. Roda inline.\n\n```yaml\n---\nname: api-conventions\ndescription: Padrões de API do projeto\n---\n\nAo criar endpoints:\n- Use nomes RESTful\n- Retorne erros consistentes\n- Valide requests\n```\n\n### 2. Skill de Tarefa (ação)\nInstruções passo-a-passo. Geralmente user-invoked.\n\n```yaml\n---\nname: deploy\ndescription: Deploy para produção\ncontext: fork\ndisable-model-invocation: true\n---\n\nDeploy da aplicação:\n1. Rodar testes\n2. Build\n3. Push para produção\n```\n\n## Controle de Invocação\n\n| Configuração | User pode | Claude pode | Uso |\n|--------------|-----------|-------------|-----|\n| (default) | Sim | Sim | Skills gerais |\n| `disable-model-invocation: true` | Sim | Não | Ações com side-effects |\n| `user-invocable: false` | Não | Sim | Conhecimento de background |\n\n## Variáveis de Substituição\n\n| Variável | Descrição |\n|----------|-----------|\n| `$ARGUMENTS` | Todos os argumentos passados |\n| `$ARGUMENTS[N]` ou `$N` | Argumento específico (0-indexed) |\n| `${CLAUDE_SESSION_ID}` | ID da sessão atual |\n| `` !`command` `` | Executa comando e insere output |\n\n## Exemplo: Skill com Argumentos\n\n```yaml\n---\nname: fix-issue\ndescription: Corrige uma issue do GitHub\ndisable-model-invocation: true\n---\n\nCorrigir issue #$ARGUMENTS:\n\n1. Ler descrição da issue\n2. Implementar correção\n3. Escrever testes\n4. Criar commit\n```\n\nUso: `/fix-issue 123`\n\n## Exemplo: Skill com Contexto Dinâmico\n\n```yaml\n---\nname: pr-summary\ndescription: Resume um PR\ncontext: fork\nagent: Explore\nallowed-tools: Bash(gh *)\n---\n\n## Contexto do PR\n- Diff: !`gh pr diff`\n- Comentários: !`gh pr view --comments`\n\n## Tarefa\nResuma este PR...\n```\n\n## Onde Colocar Skills\n\n| Local | Caminho | Alcance |\n|-------|---------|---------|\n| Pessoal | `~/.claude/skills/` | Todos os projetos |\n| Projeto | `.claude/skills/` | Este projeto |\n| Plugin | `plugin/skills/` | Onde plugin está ativo |\n\n## Criando uma Skill - Passo a Passo\n\n1. **Criar diretório:**\n```bash\nmkdir -p ~/.claude/skills/minha-skill\n```\n\n2. **Criar SKILL.md:**\n```bash\ncat > ~/.claude/skills/minha-skill/SKILL.md << 'EOF'\n---\nname: minha-skill\ndescription: Descrição clara do que faz e quando usar\n---\n\nInstruções aqui...\nEOF\n```\n\n3. **Testar:**\n```\n/minha-skill\n```\n\n## Dicas\n\n- Mantenha SKILL.md < 500 linhas\n- Use arquivos separados para referências longas\n- Descrição clara = melhor auto-invocação\n- `allowed-tools` restringe para segurança\n- `context: fork` isola side-effects\n\n## Skills em Plugins\n\nPara distribuir skills:\n\n```\nmeu-plugin/\n├── .claude-plugin/\n│   └── plugin.json\n└── skills/\n    └── minha-skill/\n        └── SKILL.md\n```\n\nSkills de plugins usam namespace: `/meu-plugin:minha-skill`\n"
      },
      {
        "path": "skills/outbound/SKILL.md",
        "content": "---\nname: outbound-manager\ndescription: |\n  Gerencia filas de outbound do sistema Ravi. Use quando o usuário quiser:\n  - Criar, configurar ou gerenciar filas de mensagens automatizadas\n  - Adicionar contatos/leads a uma fila\n  - Ver status, relatórios ou histórico de conversas\n  - Qualificar leads ou atualizar contexto\n  - Pausar/iniciar filas ou resetar entries\n---\n\n# Outbound Manager\n\nVocê gerencia as filas de outbound do Ravi. Outbound são campanhas de mensagens automatizadas para prospecção, follow-up, ou comunicação em massa.\n\n## Comandos de Fila\n\n### Listar filas\n```bash\nravi outbound list\n```\n\n### Ver detalhes da fila\n```bash\nravi outbound show <id>\n```\n\n### Criar fila\n```bash\nravi outbound create \"<nome>\" --instructions \"<prompt>\" --every <interval> --stages '<json>'\n```\n\nOpções obrigatórias:\n- `--instructions <text>` - Instruções do agent\n- `--every <interval>` - Intervalo entre entries (ex: 5m, 1h)\n- `--stages <json>` - Pipeline stages (ver seção abaixo)\n\nOpções extras:\n- `--agent <id>` - Agent que processa\n- `--description <text>` - Descrição da fila\n- `--active-start <HH:MM>` - Horário início (ex: 09:00)\n- `--active-end <HH:MM>` - Horário fim (ex: 22:00)\n- `--tz <timezone>` - Fuso horário\n- `--max-rounds <n>` - Máximo de rounds por entry\n\n### Iniciar/Pausar fila\n```bash\nravi outbound start <id>\nravi outbound pause <id>\n```\n\n### Configurar propriedades\n```bash\nravi outbound set <id> <key> <value>\n```\nKeys: name, instructions, every, agent, description, active-start, active-end, tz, stages, max-rounds\n\n### Deletar fila\n```bash\nravi outbound rm <id>\n```\n\n### Executar manualmente\n```bash\nravi outbound run <id>\n```\n\n## Comandos de Entries\n\n### Adicionar entry\n```bash\nravi outbound add <queueId> <phone> --name \"Nome\" --context '{\"empresa\":\"Acme\"}'\n```\n\nOu adicionar por tag:\n```bash\nravi outbound add <queueId> - --tag \"leads\"\n```\n\n### Listar entries\n```bash\nravi outbound entries <queueId>\n```\n\n### Ver status de entry\n```bash\nravi outbound status <entryId>\n```\n\n### Ver histórico de chat\n```bash\nravi outbound chat <entryId>\n```\n\n### Atualizar contexto\n```bash\nravi outbound context <entryId> '{\"empresa\":\"Nova Info\"}'\n```\n\n### Qualificar lead / Mudar estágio\n```bash\nravi outbound qualify <entryId> <stage>\n```\nAceita qualquer estágio definido na fila. Cada fila define seus próprios estágios.\n\n### Marcar como concluído\n```bash\nravi outbound done <entryId>\nravi outbound complete <entryId>\nravi outbound skip <entryId>\n```\n\n### Resetar entry\n```bash\nravi outbound reset <entryId>\nravi outbound reset <entryId> --full  # Limpa contexto também\n```\n\n## Relatório Completo\n\n```bash\nravi outbound report              # Todas as filas\nravi outbound report <queueId>    # Fila específica\n```\n\n## Enviar Mensagem Manual\n\n```bash\nravi outbound send <entryId> \"Mensagem\"\n```\n\nOpções:\n- `--account <id>` - Conta WhatsApp\n- `--typing-delay <ms>` - Delay de digitação\n- `--pause <ms>` - Pausa antes de digitar\n\n## Pipeline Stages\n\nCada fila **deve** definir seus próprios estágios. Não existe padrão — defina o funil que faz sentido pro caso de uso.\n\n### Formato\n```json\n[\n  { \"name\": \"novo\" },\n  { \"name\": \"engajado\", \"delay\": 30 },\n  { \"name\": \"qualificado\" },\n  { \"name\": \"perdido\" }\n]\n```\n\n- `name` — identificador do estágio\n- `delay` — minutos para follow-up automático (null/omitido = sem follow-up)\n\n### Exemplos por caso de uso\n\n**Vendas B2B:**\n```bash\nravi outbound create \"Prospecção\" --instructions \"...\" --every 5m \\\n  --stages '[{\"name\":\"cold\"},{\"name\":\"engajado\",\"delay\":30},{\"name\":\"reuniao_marcada\",\"delay\":1440},{\"name\":\"proposta\",\"delay\":4320},{\"name\":\"fechado\"},{\"name\":\"perdido\"}]'\n```\n\n**Recrutamento:**\n```bash\nravi outbound set <id> stages '[{\"name\":\"novo\"},{\"name\":\"respondeu\",\"delay\":30},{\"name\":\"interessado\",\"delay\":60},{\"name\":\"agendou_entrevista\",\"delay\":1440},{\"name\":\"contratado\"},{\"name\":\"recusou\"}]'\n```\n\n**Cobrança:**\n```bash\nravi outbound set <id> stages '[{\"name\":\"aviso\"},{\"name\":\"lembrete\",\"delay\":1440},{\"name\":\"urgente\",\"delay\":2880},{\"name\":\"ultima_chance\",\"delay\":4320},{\"name\":\"inadimplente\"}]'\n```\n\n### Como funciona\n- O agent recebe os estágios disponíveis no prompt automaticamente\n- `qualify` valida contra os estágios da fila\n- Follow-up automático usa o `delay` do estágio atual da entry\n"
      },
      {
        "path": "skills/events/SKILL.md",
        "content": "---\nname: events\ndescription: |\n  Referência do sistema de eventos NATS. Use quando precisar:\n  - Entender os tópicos e fluxo de eventos do Ravi\n  - Emitir eventos manualmente via código\n  - Debugar fluxo de mensagens entre componentes\n---\n\n# NATS Event Bus\n\nO NATS é o pub/sub central do Ravi. Todas as mensagens, prompts, tool calls e respostas passam por ele como eventos em tópicos.\n\n## Conceitos\n\n- **Topic/Subject**: Namespace hierárquico separado por `.` (ex: `ravi.session.main.prompt`)\n- **Event**: Payload JSON publicado num subject\n- **Wildcards**: `*` casa com um nível, `>` casa com múltiplos níveis\n- **Connection**: TCP direto para `nats://127.0.0.1:4222` (sem HTTP/WebSocket intermediário)\n\n## Tópicos do Ravi\n\n### Sessões (por session)\n\n| Tópico | Conteúdo |\n|--------|----------|\n| `ravi.session.{name}.prompt` | Prompts recebidos (mensagens, heartbeat, system, cross-send) |\n| `ravi.session.{name}.response` | Respostas do agent (com `target` para routing) |\n| `ravi.session.{name}.claude` | Eventos brutos do SDK Claude (typing heartbeat) |\n| `ravi.session.{name}.tool` | Tool calls (start/end com input/output) |\n| `ravi.session.abort` | Abortar sessão ephemeral |\n\n### Inbound (canais)\n\n| Tópico | Conteúdo |\n|--------|----------|\n| `whatsapp.{accountId}.inbound` | Mensagens WhatsApp recebidas (InboundMessage) |\n| `matrix.{accountId}.inbound` | Mensagens Matrix recebidas (InboundMessage) |\n| `ravi.inbound.reaction` | Reações recebidas (`emoji`, `targetMessageId`) |\n| `ravi.inbound.reply` | Replies recebidos (`targetMessageId`, `text`) |\n| `ravi.inbound.pollVote` | Votos em enquetes (`pollMessageId`, `votes`) |\n\n### Outbound\n\n| Tópico | Conteúdo |\n|--------|----------|\n| `ravi.outbound.deliver` | Mensagens de saída para canais (`channel`, `accountId`, `to`, `text`) |\n| `ravi.outbound.receipt` | Read receipts pendentes (`chatId`, `senderId`, `messageIds`) |\n| `ravi.outbound.refresh` | Sinal de refresh de filas outbound |\n\n### Contatos e Aprovações\n\n| Tópico | Conteúdo |\n|--------|----------|\n| `ravi.contacts.pending` | Novo contato/grupo pendente (`type`: contact ou account) |\n| `ravi.approval.request` | Pedido de aprovação cascading (`sessionName`, `type`, `text`) |\n| `ravi.approval.response` | Resposta de aprovação (`approved`, `reason`) |\n\n### Sistema e Config\n\n| Tópico | Conteúdo |\n|--------|----------|\n| `ravi.config.changed` | Configuração alterada via CLI |\n| `ravi.triggers.refresh` | Sinal de refresh de triggers |\n| `ravi.heartbeat.refresh` | Sinal de refresh de timers heartbeat |\n\n### CLI Tools (emitidos pelo bot)\n\n| Tópico | Conteúdo |\n|--------|----------|\n| `ravi.{sessionKey}.cli.{group}.{command}` | Execuções de CLI tools pelo agent |\n\n## API (src/nats.ts)\n\n```typescript\nimport { nats } from \"./nats.js\";\n\n// Publicar evento\nawait nats.emit(\"ravi.session.main.prompt\", { prompt: \"oi\" });\n\n// Subscribir a tópicos (wildcards)\nfor await (const event of nats.subscribe(\"ravi.session.*.prompt\")) {\n  console.log(event.topic, event.data);\n}\n\n// Múltiplos tópicos\nfor await (const event of nats.subscribe(\"ravi.session.*.response\", \"ravi.session.*.tool\")) {\n  console.log(event.topic, event.data);\n}\n```\n\n## Relação com Triggers\n\nO Ravi tem um sistema de **triggers** (`ravi triggers`) que reagem automaticamente a eventos NATS.\n\n- **NATS** = barramento de eventos (pub/sub)\n- **triggers** = reações automáticas quando um evento matching acontece\n\nPara gerenciar triggers, use `ravi triggers --help`.\n"
      },
      {
        "path": "skills/matrix/SKILL.md",
        "content": "---\nname: matrix-manager\ndescription: |\n  Gerencia contas e comunicação Matrix. Use quando o usuário quiser:\n  - Adicionar, listar ou remover contas Matrix\n  - Enviar mensagens via Matrix\n  - Ver ou criar salas/rooms\n  - Convidar usuários para salas\n  - Verificar status de conexão\n---\n\n# Matrix Manager\n\nMatrix é um protocolo de mensagens federado. Ravi usa Matrix para comunicação entre agents e usuários.\n\n## Gerenciamento de Contas\n\n### Listar contas\n```bash\nravi matrix users-list\n```\n\n### Adicionar conta (login ou registro)\n```bash\nravi matrix users-add <username> -p <password>\nravi matrix users-add <username> -p <password> -h https://matrix.org\n```\n\n### Remover conta\n```bash\nravi matrix users-remove <username>\n```\n\n### Verificar identidade\n```bash\nravi matrix whoami <account>\n```\n\n### Status de conexão\n```bash\nravi matrix status\nravi matrix status <agent>\n```\n\n## Contas de Agents\n\nAgents podem ter contas Matrix associadas:\n\n### Registrar conta pra agent\n```bash\nravi matrix register <agent>\nravi matrix register <agent> -h http://localhost:8008 -u username -p password\n```\n\n### Login de agent\n```bash\nravi matrix login <agent>\n```\n\n### Logout de agent\n```bash\nravi matrix logout <agent>\n```\n\n### Listar contas de agents\n```bash\nravi matrix accounts\n```\n\n## Salas (Rooms)\n\n### Listar salas\n```bash\nravi matrix rooms <account>\n```\n\n### Criar sala\n```bash\nravi matrix create-room <account> \"Nome da Sala\"\nravi matrix create-room <account> \"Sala Pública\" --public\nravi matrix create-room <account> \"Com Alias\" --alias minha-sala\nravi matrix create-room <account> \"Com Convite\" --invite @user:server\n```\n\n### Entrar em sala\n```bash\nravi matrix join <account> <room_id>\nravi matrix join <account> \"#alias:server\"\n```\n\n### Convidar pra sala\n```bash\nravi matrix invite <target_user> <room_id> --from <account>\n```\n\n### Criar DM\n```bash\nravi matrix dm <from_account> <to_account_or_user>\n```\n\n## Mensagens\n\n### Ver mensagens\n```bash\nravi matrix messages <account> <room_id>\nravi matrix messages <account> <room_id> --limit 50\n```\n\n### Enviar mensagem\n```bash\nravi matrix send <account> <room_id> \"Mensagem\"\nravi matrix send <account> @user:server \"DM direto\"\n```\n\n## Exemplos\n\nCriar conta e enviar mensagem:\n```bash\nravi matrix users-add bot -p senha123\nravi matrix send bot \"#geral:localhost\" \"Olá!\"\n```\n\nConfigurar agent com Matrix:\n```bash\nravi matrix register meu-agent -h http://localhost:8008\nravi agents set meu-agent matrixAccount meu-agent\nravi daemon restart\n```\n\nCriar sala privada entre agents:\n```bash\nravi matrix create-room agent1 \"Discussão\" --invite @agent2:localhost\nravi matrix join agent2 \"!roomid:localhost\"\n```\n"
      },
      {
        "path": "skills/routes/SKILL.md",
        "content": "---\nname: routes-manager\ndescription: |\n  Gerencia rotas de mensagens do Ravi. Use quando o usuário quiser:\n  - Criar, listar ou remover rotas\n  - Direcionar contatos/grupos para agents específicos\n  - Configurar prioridade de rotas\n  - Ver qual agent atende qual padrão\n---\n\n# Routes Manager\n\nRotas direcionam mensagens para agents baseado em padrões. Um contato ou grupo pode ser roteado para um agent específico.\n\n## Comandos\n\n### Listar rotas\n```bash\nravi routes list\n```\n\n### Ver detalhes\n```bash\nravi routes show <pattern>\n```\n\n### Adicionar rota\n```bash\nravi routes add <pattern> <agent>\n```\n\nExemplos de padrões:\n- `5511*` - Todos com DDD 11\n- `*999*` - Números contendo 999\n- `group:123456` - Grupo específico do WhatsApp\n- `*` - Catch-all (fallback)\n\n### Remover rota\n```bash\nravi routes remove <pattern>\n```\n\n### Configurar propriedades\n```bash\nravi routes set <pattern> <key> <value>\n```\n\nKeys:\n- `priority` - Prioridade (maior = mais prioritário)\n- `dmScope` - Escopo de DM (main, per-peer, etc)\n\n## Prioridade de Resolução\n\n1. Contato com agent atribuído diretamente\n2. Rota que casa com o padrão (por prioridade)\n3. AccountId = AgentId\n4. Agent default\n\n## Exemplos\n\nRotear grupo para agent especializado:\n```bash\nravi routes add \"group:120363123456789@g.us\" projeto-x\n```\n\nRotear todos de SP para agent:\n```bash\nravi routes add \"5511*\" vendas\n```\n\nDefinir fallback:\n```bash\nravi routes add \"*\" main\n```\n\n## Relação com Contacts\n\nRoutes e Contacts trabalham juntos no roteamento:\n\n- **Contacts** podem ter `agent_id` atribuído diretamente (via `ravi contacts set <phone> agent <agent>` ou `ravi contacts approve <phone> <agent>`)\n- **Routes** definem regras por padrão (prefixo, grupo, catch-all)\n- Na resolução, `contact.agent_id` tem prioridade sobre routes\n- `ravi routes list` mostra o nome e status do contato associado a cada padrão\n- Para gerenciar contatos: use a skill `ravi-system:contacts`\n"
      },
      {
        "path": "skills/whatsapp/SKILL.md",
        "content": "---\nname: whatsapp-manager\ndescription: |\n  Gerencia funcionalidades do WhatsApp via Baileys. Use quando o usuário quiser:\n  - Criar, gerenciar ou sair de grupos\n  - Adicionar/remover membros de grupos\n  - Gerar ou revogar links de convite\n  - Renomear grupos ou mudar descrição\n  - Alterar configurações de grupo (anúncio, locked)\n  - Entrar em grupo via link de convite\n  - Listar todos os grupos que o bot participa\n---\n\n# WhatsApp Manager\n\nFuncionalidades do WhatsApp expostas via Baileys. Permite gerenciar grupos, membros, convites e configurações diretamente pelo CLI.\n\n**Importante:** Todos os comandos precisam que o daemon esteja rodando com WhatsApp conectado. Os comandos se comunicam com o daemon via NATS (request/reply).\n\n## Gerenciamento de Grupos\n\n### Listar grupos\n```bash\nravi whatsapp group list\n```\n\n### Ver info de um grupo\n```bash\nravi whatsapp group info <groupId>\n```\n\nO `groupId` aceita:\n- JID completo: `120363425628305127@g.us`\n- Formato normalizado: `group:120363425628305127`\n\n### Criar grupo\n```bash\nravi whatsapp group create \"Nome do Grupo\" \"5511999999999,5511888888888\"\n```\n\nParticipantes separados por vírgula. Aceita números de telefone ou JIDs.\n\n**Com agent (recomendado):** Auto-aprova o contato e cria a rota pro agent num comando só:\n```bash\nravi whatsapp group create \"Vida - Health\" \"5511947879044\" --agent health\n```\n\nSaída:\n```\n✓ Group created: Vida - Health\n  ID:           120363405113391144@g.us\n  Participants: 2\n  Contact:      approved\n  Route:        health\n```\n\n### Sair de um grupo\n```bash\nravi whatsapp group leave <groupId>\n```\n\n## Membros\n\n### Adicionar participantes\n```bash\nravi whatsapp group add <groupId> \"5511999999999,5511888888888\"\n```\n\n### Remover participantes\n```bash\nravi whatsapp group remove <groupId> \"5511999999999\"\n```\n\n### Promover a admin\n```bash\nravi whatsapp group promote <groupId> \"5511999999999\"\n```\n\n### Remover admin\n```bash\nravi whatsapp group demote <groupId> \"5511999999999\"\n```\n\n## Convites\n\n### Gerar link de convite\n```bash\nravi whatsapp group invite <groupId>\n```\n\nRetorna o link `https://chat.whatsapp.com/...`\n\n### Revogar link (gera novo)\n```bash\nravi whatsapp group revoke-invite <groupId>\n```\n\n### Entrar via link\n```bash\nravi whatsapp group join \"https://chat.whatsapp.com/ABC123\"\n# ou só o código:\nravi whatsapp group join ABC123\n```\n\n## Configurações\n\n### Renomear grupo\n```bash\nravi whatsapp group rename <groupId> \"Novo Nome\"\n```\n\n### Mudar descrição\n```bash\nravi whatsapp group description <groupId> \"Nova descrição do grupo\"\n```\n\n### Alterar settings\n```bash\nravi whatsapp group settings <groupId> <setting>\n```\n\nSettings disponíveis:\n- `announcement` — só admins enviam mensagens\n- `not_announcement` — todos enviam mensagens\n- `locked` — só admins editam info do grupo\n- `unlocked` — todos editam info do grupo\n\n## Multi-account\n\nTodos os comandos aceitam `--account <id>` pra especificar qual conta WhatsApp usar. Default: `default`.\n\n```bash\nravi whatsapp group list --account business\nravi whatsapp group create \"Equipe\" \"5511999\" --account business\n```\n\n## Exemplos Práticos\n\n### Criar grupo pra um agent\n```bash\n# Tudo num comando só:\nravi whatsapp group create \"Vida - Finanças\" \"5511947879044\" --agent financas\n```\n\nSem `--agent`, o grupo é criado e aprovado automaticamente, mas sem rota — precisa rotear manualmente:\n```bash\nravi whatsapp group create \"Grupo Avulso\" \"5511999999999\"\nravi routes add group:<id> meu-agent\n```\n\n### Gerenciar membros de equipe\n```bash\n# Ver quem tá no grupo\nravi whatsapp group info group:120363425628305127\n\n# Adicionar novo membro\nravi whatsapp group add group:120363425628305127 \"5511777777777\"\n\n# Promover a admin\nravi whatsapp group promote group:120363425628305127 \"5511777777777\"\n```\n\n### Gerar convite temporário\n```bash\n# Gerar link\nravi whatsapp group invite group:120363425628305127\n# → https://chat.whatsapp.com/ABC123\n\n# Depois de todos entrarem, revogar\nravi whatsapp group revoke-invite group:120363425628305127\n```\n"
      },
      {
        "path": "skills/cron/SKILL.md",
        "content": "---\nname: cron-manager\ndescription: |\n  Gerencia jobs agendados do sistema Ravi. Use quando o usuário quiser:\n  - Criar, listar ou deletar tarefas agendadas\n  - Configurar cron expressions, intervalos ou horários específicos\n  - Ativar/desativar jobs existentes\n  - Executar jobs manualmente\n---\n\n# Cron Manager\n\nVocê gerencia os jobs agendados do Ravi. Jobs são tarefas que rodam automaticamente em horários ou intervalos específicos.\n\n## Tipos de Schedule\n\n| Tipo | Exemplo | Descrição |\n|------|---------|-----------|\n| `--cron` | `\"0 9 * * *\"` | Cron expression (todo dia 9h) |\n| `--every` | `30m`, `1h`, `2h30m` | Intervalo fixo |\n| `--at` | `2025-02-01T15:00` | Horário único (one-shot) |\n\n## Comandos Disponíveis\n\n### Listar jobs\n```bash\nravi cron list\n```\n\n### Ver detalhes\n```bash\nravi cron show <id>\n```\n\n### Criar job\n\nCom cron expression:\n```bash\nravi cron add \"Relatório Diário\" --cron \"0 9 * * *\" --message \"Gere o relatório diário\"\n```\n\nCom intervalo:\n```bash\nravi cron add \"Check Emails\" --every 30m --message \"Verifique novos emails\"\n```\n\nOne-shot (executa uma vez):\n```bash\nravi cron add \"Lembrete\" --at \"2025-02-01T15:00\" --message \"Lembrar de X\" --delete-after\n```\n\nOpções:\n- `--agent <id>` - Agent que executa\n- `--tz <timezone>` - Fuso horário (ex: America/Sao_Paulo)\n- `--isolated` - Roda em sessão isolada\n- `--delete-after` - Deleta após primeira execução\n- `--description <text>` - Descrição do job\n\n### Ativar/Desativar\n```bash\nravi cron enable <id>\nravi cron disable <id>\n```\n\n### Configurar propriedades\n```bash\nravi cron set <id> <key> <value>\n```\n\nKeys: name, message, cron, every, tz, agent, description, session, delete-after\n\n### Executar manualmente\n```bash\nravi cron run <id>\n```\n\n### Deletar\n```bash\nravi cron rm <id>\n```\n\n## Cron Expression Reference\n\n```\n┌───────────── minuto (0-59)\n│ ┌───────────── hora (0-23)\n│ │ ┌───────────── dia do mês (1-31)\n│ │ │ ┌───────────── mês (1-12)\n│ │ │ │ ┌───────────── dia da semana (0-6, 0=domingo)\n│ │ │ │ │\n* * * * *\n```\n\nExemplos:\n- `0 9 * * *` - Todo dia às 9h\n- `0 9 * * 1-5` - Dias úteis às 9h\n- `*/15 * * * *` - A cada 15 minutos\n- `0 0 1 * *` - Primeiro dia do mês à meia-noite\n- `0 18 * * 5` - Toda sexta às 18h\n\n## Exemplos\n\nRelatório semanal toda segunda:\n```bash\nravi cron add \"Weekly Report\" --cron \"0 9 * * 1\" --message \"Gere relatório semanal\" --tz \"America/Sao_Paulo\"\n```\n\nVerificação a cada 2 horas:\n```bash\nravi cron add \"Health Check\" --every 2h --message \"Verifique status dos sistemas\"\n```\n\nLembrete único:\n```bash\nravi cron add \"Reunião\" --at \"2025-01-30T14:00\" --message \"Lembrar: reunião em 15min\" --delete-after\n```\n"
      },
      {
        "path": "skills/channels/SKILL.md",
        "content": "---\nname: channels-manager\ndescription: |\n  Gerencia canais de comunicação do Ravi. Use quando o usuário quiser:\n  - Ver status dos canais (WhatsApp, Matrix)\n  - Iniciar, parar ou reiniciar canais\n  - Verificar conexão do WhatsApp\n  - Troubleshoot problemas de conexão\n---\n\n# Channels Manager\n\nCanais são as interfaces de comunicação (WhatsApp, Matrix, etc).\n\n## Comandos\n\n### Ver status\n```bash\nravi channels status\nravi channels status whatsapp\nravi channels status matrix\n```\n\n### Listar canais\n```bash\nravi channels list\n```\n\n### Iniciar canal\n```bash\nravi channels start <target>\n```\n\n### Parar canal\n```bash\nravi channels stop <target>\n```\n\n### Reiniciar canal\n```bash\nravi channels restart <target>\n```\n\n## Targets\n\n- `whatsapp` - Gateway WhatsApp\n- `matrix` - Gateway Matrix\n- `<accountId>` - Conta específica\n\n## Troubleshooting\n\n### WhatsApp desconectado\n```bash\nravi channels status whatsapp\nravi channels restart whatsapp\n```\n\n### Ver QR code novamente\n```bash\nravi service wa\n```\n\n### Matrix não conecta\n```bash\nravi channels status matrix\nravi matrix status\n```\n"
      }
    ]
  },
  {
    "name": "ravi-dev",
    "manifest": {
      "name": "ravi-dev",
      "version": "1.0.0",
      "description": "Ravi meta-development skills - architecture docs, prompt system, and internal patterns"
    },
    "files": [
      {
        "path": ".claude-plugin/plugin.json",
        "content": "{\n  \"name\": \"ravi-dev\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Ravi meta-development skills - architecture docs, prompt system, and internal patterns\"\n}\n"
      },
      {
        "path": "skills/architecture/SKILL.md",
        "content": "---\nname: ravi-architecture\ndescription: |\n  Documentacao completa da arquitetura do Ravi. Use quando precisar:\n  - Entender como o sistema funciona end-to-end\n  - Modificar componentes existentes\n  - Adicionar novos subsistemas\n  - Debugar fluxos de mensagem\n  - Onboarding no codebase\n---\n\n# Ravi - Arquitetura do Sistema\n\nRavi e um sistema multi-agent construido sobre o Claude Agent SDK que orquestra conversas em multiplas plataformas (WhatsApp, Matrix, TUI).\n\n**Repositorio:** `/Users/luis/dev/filipelabs/ravi.bot`\n**Runtime:** Bun | **DB:** SQLite | **PubSub:** NATS | **AI:** Claude SDK\n\n## Fluxo Principal de Mensagens\n\n```\n[WhatsApp/Matrix/TUI]\n    -> Channel Plugin (normaliza mensagem)\n    -> Gateway (formata envelope, resolve rota)\n    -> nats.emit(\"ravi.{sessionKey}.prompt\")\n    -> RaviBot (Claude SDK query)\n    -> nats.emit(\"ravi.{sessionKey}.response\")\n    -> Gateway (roteia para canal)\n    -> [WhatsApp/Matrix/TUI]\n```\n\n## Componentes Core\n\n### daemon.ts - Ponto de Entrada\nOrquestra startup de todos os subsistemas:\n1. Carrega env de `~/.ravi/.env`\n2. Inicia RaviBot (Claude SDK)\n3. Cria Gateway com channel plugins\n4. Registra WhatsApp + Matrix\n5. Inicia HeartbeatRunner, CronRunner, OutboundRunner, TriggerRunner\n\n### gateway.ts - Orquestrador de Mensagens\n**Inbound:** Channel normaliza msg -> Gateway resolve rota -> emite prompt\n**Outbound:** Bot emite response -> Gateway extrai target -> envia pro canal\n\nSubscriptions importantes:\n- `{channelId}.*.inbound` - Msgs dos canais\n- `ravi.*.response` - Respostas do bot\n- `ravi.outbound.deliver` - Envio direto do outbound\n- `ravi.media.send` - Envio de midia\n\nFeatures:\n- Ghost detection via `_emitId` (previne duplicatas de restarts)\n- Typing indicator automatico\n- Outbound suppression (msgs de contatos outbound nao geram prompt)\n\n### bot.ts - Core do Bot\nProcessa prompts usando Claude Agent SDK.\n\n**Fluxo:**\n1. Subscribe em `ravi.*.prompt`\n2. Resolve agent config pela session key\n3. Debounce se configurado\n4. Cria/resume SDK session\n5. Streama resposta -> emite responses parciais\n6. Gerencia interrupts (msg nova durante processamento)\n\n**Interrupt handling:**\n- Tool rodando -> enfileira msg\n- Sem tool -> aborta query atual\n- Apos tool terminar -> checa fila -> interrupt\n- Msgs enfileiradas sao combinadas em 1 prompt\n\n**Abort control:**\n- Cada sessao tem AbortController\n- Novo prompt aborta subprocess anterior\n- Daemon stop aborta TODOS os controllers\n- Watchdog de 5min detecta sessoes travadas\n\n### router/ - Sistema de Roteamento\n\n**Resolucao de rota (prioridade):**\n1. Agent atribuido ao contato\n2. Rota com pattern match\n3. AccountId = AgentId (Matrix)\n4. Agent default\n\n**Session keys:**\n```\nagent:{agentId}:{scope}:{peerId}\nagent:main:main                          # Todas DMs (scope=main)\nagent:main:dm:5511999                    # Por contato\nagent:main:whatsapp:group:123456         # Grupo\nagent:main:outbound:queueId:phone        # Outbound\n```\n\n**DM Scopes:**\n- `main` - Todas DMs compartilham 1 sessao\n- `per-peer` - Isolado por contato (default)\n- `per-channel-peer` - Isolado por canal+contato\n- `per-account-channel-peer` - Isolamento total\n\n**Arquivos:**\n- `router/resolver.ts` - Resolve rota -> session key\n- `router/session-key.ts` - Constroi/parseia session keys\n- `router/sessions.ts` - CRUD de sessoes (SQLite)\n- `router/config.ts` - Carrega config de agents/routes\n- `router/router-db.ts` - Camada de banco\n\n### channels/ - Abstracao de Canais\n\nInterface unificada para plataformas de mensagem.\n\n**Adapters:**\n- ConfigAdapter - Configuracao de contas\n- SecurityAdapter - Controle de acesso\n- OutboundAdapter - Envio de msgs, typing, reactions\n- GatewayAdapter - Lifecycle de conexao\n- StatusAdapter - Health monitoring\n\n**WhatsApp (`channels/whatsapp/`):**\n- Baileys SDK, multi-account, QR pairing\n- Media download com limites de tamanho\n- Transcricao de audio (OpenAI Whisper)\n- JID/LID resolution\n- Sessao em `~/ravi/sessions/whatsapp/{accountId}/`\n\n**Matrix (`channels/matrix/`):**\n- matrix-bot-sdk, multi-account\n- E2E encryption, device verification\n- Credenciais em `~/ravi/sessions/matrix/accounts.json`\n- Cada agent pode ter matrixAccount diferente\n\n## Subsistemas de Automacao\n\n### Outbound (`outbound/`)\nCampanhas de mensagens proativas com processamento round-robin.\n\n**Fluxo:**\n1. Runner pega proxima queue do DB\n2. Arma timer para `nextRunAt`\n3. Processa entries por prioridade:\n   - Response entries (contato respondeu)\n   - Follow-up entries (sem resposta, precisa follow-up)\n   - Initial outreach (entries pendentes)\n4. Manda prompt para agent com contexto da campanha\n\n**Qualificacao:** cold -> warm -> interested -> qualified/rejected\n\n### Triggers (`triggers/`)\nAutomacao event-driven disparada por eventos do sistema.\n\n**Fluxo:**\n1. Runner subscribe em topics configurados\n2. Evento dispara -> busca triggers ativos com match\n3. Emite prompt para sessao target do trigger\n4. Respeita cooldown entre disparos\n\n### Cron (`cron/`)\nJobs agendados com suporte a multiplos formatos.\n\n**Schedules:** cron expression | interval (\"30m\") | daily (\"09:00\") | at (one-time)\n\n**Fluxo:** Timer -> job due -> emite prompt -> calcula proximo run\n\n### Heartbeat (`heartbeat/`)\nCheck-ins periodicos de agents dentro de horarios ativos.\n\n**Fluxo:**\n1. Checa agents com heartbeat enabled\n2. Para cada sessao, verifica se esta due\n3. Checa active hours (timezone-aware)\n4. Envia prompt de status check\n5. `HEARTBEAT_OK` = silencioso, qualquer outro texto = envia pro canal\n\n### Session Messaging (`cli/commands/sessions.ts`)\nMensagens entre sessoes (inter-session communication).\n\n**Comandos:** `sessions send` | `sessions inform` | `sessions execute` | `sessions ask` | `sessions answer`\n\n**Ask/Answer flow:**\n1. Agent A: `ravi sessions ask <target-session> \"pergunta\" \"sender\"`\n2. Bot emite `[System] Ask:` para target\n3. Agent B responde, usa `ravi sessions answer <origin-session> \"resposta\" \"sender\"`\n4. Bot emite `[System] Answer:` para origin\n\n## Sistema de Plugins\n\n**Duas fontes:**\n1. **Internos** - Embutidos no build, extraidos para `~/.cache/ravi/plugins/`\n2. **Usuario** - Customizados em `~/ravi/plugins/`\n\n**Build time:** `gen-plugins.ts` escaneia `src/plugins/internal/` e gera `internal-registry.ts`\n**Runtime:** `discoverPlugins()` extrai internos + escaneia user dir -> passa para SDK\n\n## Sistema de Hooks\n\n### PreToolUse (bash/hook.ts)\nIntercepta chamadas Bash e valida permissoes via REBAC.\nCheca `agentCan(id, \"execute\", \"executable\", exec)` pra cada executavel parsed.\n\n### PreCompact (hooks/pre-compact.ts)\nExtrai memorias antes do SDK compactar contexto.\nLe `COMPACT_INSTRUCTIONS.md` do agent, roda modelo barato em background, atualiza `MEMORY.md`.\n\n## Infraestrutura CLI\n\n### Decorators\n```typescript\n@Group({ name: \"agents\" })\nclass AgentCommands {\n  @Command({ name: \"list\" })\n  list() { ... }\n\n  @Command({ name: \"create\" })\n  create(@Arg(\"id\") id: string) { ... }\n}\n```\n\n### Contexto (AsyncLocalStorage)\n```typescript\nrunWithContext({ sessionKey, agentId, source }, async () => {\n  // CLI tools acessam contexto sem parametros\n  const ctx = getContext();\n});\n```\n\n## Storage\n\n```\n~/ravi/ravi.db          - SQLite: agents, routes, sessions, contacts, settings\n~/.ravi/.env            - API keys e env vars\n~/.ravi/logs/           - Logs do daemon\n~/ravi/{agent-id}/      - Diretorios dos agents (CLAUDE.md, MEMORY.md)\n~/ravi/sessions/        - Sessoes dos canais (WhatsApp, Matrix)\n~/.cache/ravi/plugins/  - Plugins internos extraidos\n~/.claude/sessions/     - SDK session files (JSONL)\n```\n\n## Padroes Importantes\n\n1. **PubSub via NATS** - Tudo comunica via topics\n2. **Ghost detection** - `_emitId` + `_instanceId` previne duplicatas\n3. **Abort control** - AbortController por sessao, cleanup no stop\n4. **Debouncing** - Agrupa msgs rapidas por window configuravel\n5. **Outbound suppression** - Msgs de contatos outbound nao geram prompt duplicado\n6. **Silent token** - `@@SILENT@@` suprime emissao pro canal\n7. **Session resumption** - SDK sessions persistem entre mensagens\n"
      },
      {
        "path": "skills/prompt-builder/SKILL.md",
        "content": "---\nname: prompt-builder\ndescription: |\n  Documenta o sistema de construcao de prompts do Ravi. Use quando precisar:\n  - Entender como system prompts sao montados\n  - Adicionar novas secoes ao prompt\n  - Modificar formatacao por canal\n  - Entender injecao de contexto (grupo, reactions, runtime)\n  - Criar novas regras de output por plataforma\n---\n\n# Prompt Builder - Sistema de Injecao de Contexto\n\nO prompt builder constroi o system prompt appendix que e injetado em cada chamada do Claude SDK.\nEle adapta o comportamento do agent baseado no canal, grupo, e contexto da mensagem.\n\n**Arquivo:** `src/prompt-builder.ts`\n\n## Como Funciona\n\n```typescript\n// bot.ts - na hora de processar prompt\nconst systemPromptAppend = buildSystemPrompt(agent.id, prompt.context);\n\nquery({\n  prompt: prompt.prompt,\n  options: {\n    systemPrompt: {\n      type: \"preset\",\n      preset: \"claude_code\",\n      append: systemPromptAppend,  // <-- injetado aqui\n    },\n  },\n});\n```\n\nO SDK usa o preset `claude_code` como base e appenda nossas secoes.\n\n## Estrutura do Builder\n\n```typescript\nclass PromptBuilder {\n  section(title: string, content: string): this;\n  build(): string;  // Retorna \"## Title\\n\\nContent\" para cada secao\n}\n```\n\n## Secoes Injetadas\n\nA funcao `buildSystemPrompt(agentId, ctx)` monta as secoes:\n\n### 1. Identidade (sempre)\n```\n## Identidade\nVoce e Ravi.\n```\n\n### 2. System Commands (sempre)\nProtocolo de comandos internos:\n- `[System] Inform: <info>` - Avalie a info e decida: silêncio (@@SILENT@@), resposta breve, ou ação com tools\n- `[System] Execute: <task>` - Execute usando tools\n- `[System] Ask: [from: <session>] <question>` - Pergunta cross-session\n- `[System] Answer: [from: <session>] <response>` - Resposta cross-session\n- *(relay não tem prefixo — chega como mensagem normal)*\n\n### 3. Runtime (quando tem contexto de canal)\n```\nRuntime: agent=main | channel=WhatsApp | capabilities=polls,reactions\n```\n\n### 4. Output Formatting (quando tem contexto de canal)\nFormatacao adaptada por plataforma:\n\n**WhatsApp:**\n- Listas com emojis numerados (1, 2, 3)\n- Icones visuais para hierarquia\n- Status com check/x\n- Sem tabelas markdown\n- Conciso (telas mobile)\n\n**Matrix:**\n- Markdown rico (tabelas, negrito, codigo)\n\n**TUI:**\n- ASCII tables (| - +)\n\n### 5. Reactions (quando tem contexto de canal)\nInstrucoes de quando usar emoji reactions vs texto:\n- Prefira emoji sobre \"ok\", \"entendi\", \"beleza\"\n- Use `react_send` com o `[mid:ID]` da mensagem\n- Nao reaja E responda ao mesmo tempo\n\n### 6. Contexto de Grupo (quando isGroup=true)\n```\nVoce esta respondendo no grupo \"Familia\".\nMembros: Joao, Maria, Luis.\nSeja seletivo: responda so quando mencionado ou claramente util.\nSe nao precisa responder: @@SILENT@@\n```\n\n## Fluxo de Contexto\n\n```\nWhatsApp msg recebida\n    -> Channel normaliza -> InboundMessage\n    -> Gateway extrai MessageContext:\n       { channelId, channelName, senderId, isGroup, groupName, groupMembers, ... }\n    -> Emite para bot com context\n    -> bot.ts chama buildSystemPrompt(agentId, context)\n    -> Prompt appendix montado com secoes relevantes\n    -> Passado para Claude SDK\n```\n\n## MessageContext (origem)\n\n```typescript\ninterface MessageContext {\n  channelId: string;       // \"whatsapp\"\n  channelName: string;     // \"WhatsApp\"\n  accountId: string;       // \"default\"\n  chatId: string;          // \"5511999999999\"\n  messageId: string;       // ID da msg\n  senderId: string;        // Quem mandou\n  senderName?: string;     // Nome do remetente\n  senderPhone?: string;    // Telefone\n  isGroup: boolean;\n  groupName?: string;\n  groupId?: string;\n  groupMembers?: string[];\n  timestamp: number;\n}\n```\n\n## ChannelContext (persistido)\n\nMetadados estaveis que sao salvos na sessao para reuso:\n\n```typescript\ninterface ChannelContext {\n  channelId: string;\n  channelName: string;\n  isGroup: boolean;\n  groupName?: string;\n  groupId?: string;\n  groupMembers?: string[];\n}\n```\n\nSalvo em `sessions.last_context` como JSON. Usado pelo cross-send para reconstruir contexto.\n\n## Silent Token\n\n```typescript\nexport const SILENT_TOKEN = \"@@SILENT@@\";\n```\n\nQuando o agent responde com este token:\n- Gateway NAO envia para o canal\n- Bot emite evento `{ type: \"silent\" }` para parar typing\n- Usado em grupos quando nao precisa responder\n\n## Como Adicionar uma Nova Secao\n\n1. Crie a funcao no `prompt-builder.ts`:\n```typescript\nfunction minhaSecao(ctx: ChannelContext): string {\n  return `Instrucoes especificas aqui...`;\n}\n```\n\n2. Adicione ao builder em `buildSystemPrompt()`:\n```typescript\nbuilder.section(\"Minha Secao\", minhaSecao(ctx));\n```\n\n3. Rebuild e reinicie o daemon.\n\n## Como Adicionar Formatacao para Novo Canal\n\n1. Adicione um case em `outputFormattingText()`:\n```typescript\nif (channelName === \"MeuCanal\") {\n  return `Regras de formatacao para MeuCanal...`;\n}\n```\n\n2. O channelName vem do `ChannelPlugin.meta.name`.\n\n## Outbound System Context\n\nO sistema de outbound injeta contexto adicional via `prompt._outboundSystemContext`:\n```typescript\nif (prompt._outboundSystemContext) {\n  systemPromptAppend += \"\\n\\n\" + prompt._outboundSystemContext;\n}\n```\n\nIsso inclui:\n- Instrucoes da queue\n- Tools disponiveis (outbound_send, outbound_qualify, etc)\n- Workflow de qualificacao\n- Metadata da entry (ID, round, qualification)\n"
      }
    ]
  }
];

/** Get internal plugin by name */
export function getInternalPlugin(name: string): InternalPlugin | undefined {
  return INTERNAL_PLUGINS.find(p => p.name === name);
}

/** Get all internal plugin names */
export function getInternalPluginNames(): string[] {
  return INTERNAL_PLUGINS.map(p => p.name);
}
