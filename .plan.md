# Plano: Separar Usuários Matrix de Agentes

## Problema Atual
- Credenciais Matrix estão em JSON (`~/.ravi/matrix-credentials.json`)
- Credenciais são vinculadas a agentes (1:1)
- Para testar, preciso criar agentes falsos (luis) só para enviar mensagens
- Comando `test` é específico demais

## Solução

### 1. Nova tabela `matrix_users` no ravi.db

```sql
CREATE TABLE IF NOT EXISTS matrix_users (
  username TEXT PRIMARY KEY,        -- "luis", "testbot", etc
  user_id TEXT NOT NULL,            -- "@luis:localhost"
  homeserver TEXT NOT NULL,         -- "http://localhost:8008"
  access_token TEXT NOT NULL,
  device_id TEXT,
  created_at INTEGER NOT NULL,
  last_used_at INTEGER
);
```

### 2. Novos comandos CLI

```bash
# Gerenciar usuários Matrix (não agentes!)
ravi matrix users list                              # Listar usuários
ravi matrix users add <user> -p <pass> [-h <hs>]   # Criar/logar usuário
ravi matrix users remove <user>                     # Remover usuário

# Enviar como qualquer usuário (não só agentes)
ravi matrix send-as <user> <room> <message>        # Enviar como usuário
ravi matrix messages-as <user> <room>              # Ver mensagens como usuário
```

### 3. Renomear/Remover `test` command
- Remover `ravi matrix test` (era específico demais)
- Usar `ravi matrix send-as luis <room> <msg>` no lugar

### 4. Migração de credenciais de agentes
- Manter JSON para agentes (daemon usa)
- Usuários de teste vão apenas no banco
- Não há migração necessária

## Arquivos a modificar

1. `src/router/router-db.ts` - Adicionar tabela e funções CRUD
2. `src/cli/commands/matrix.ts` - Adicionar comandos `users` e `send-as`

## Fluxo de teste após implementação

```bash
# Setup
ravi matrix users add luis -p test123 -h http://localhost:8008
ravi matrix users add testbot -p test123

# Teste 1: Resposta
ravi matrix create-room main "Teste" -i @luis:localhost
ravi matrix send-as luis "!roomId" "Oi Ravi!"
ravi matrix messages main "!roomId"

# Teste 2: Memória
ravi matrix send-as luis "!roomId" "Lembra: minha cor é ROXO"
# espera...
ravi matrix send-as luis "!roomId" "Qual minha cor?"
ravi matrix messages main "!roomId"

# Teste 3: Grupo
ravi matrix create-room main "Grupo" -i @luis:localhost,@testbot:localhost
ravi matrix send-as luis "!roomId" "Oi sou Luis"
ravi matrix send-as testbot "!roomId" "Oi sou Testbot"
ravi matrix send-as luis "!roomId" "Ravi, quem está aqui?"
ravi matrix messages main "!roomId"
```
